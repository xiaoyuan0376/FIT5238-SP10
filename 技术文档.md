# 技术文档：DDoS流量分析系统

### 1. 概述

#### 1.1. 项目目标

DDoS流量分析系统是一个基于Web的应用程序，旨在为用户提供一个友好的界面，用于分析来自CSV文件的网络流量数据。用户可以上传文件，系统将利用一个预训练的深度学习模型来预测每一条流量是`良性（BENIGN）`还是`DDoS攻击`的一部分。系统会生成全面的分析结果，包括详细报告、风险评估以及对高风险“告警”流量的重点摘要。

#### 1.2. 核心技术栈

*   **后端框架:** Python with Flask
*   **AI/ML框架:** PyTorch
*   **数据处理:** Pandas & NumPy
*   **前端:** HTML5, CSS3, JavaScript (使用Jinja2进行模板渲染)
*   **核心AI模型:** 一个堆叠式长短期记忆网络 (LSTM)

#### 1.3. 目标读者

本文档主要面向参与该系统后续维护、部署或未来开发的软件工程师、系统架构师和数据科学家。

---

### 2. 系统设计与架构

#### 2.1. 架构风格

本系统被设计为一个**单体Web应用（Monolithic Web Application）**，采用**分层架构**，强调清晰的**关注点分离（Separation of Concerns）**。

*   **表现层 (Presentation Layer):** 由 `app.py` 和 `templates/` & `static/` 目录组成，负责处理用户交互和页面展示。
*   **业务逻辑层 (Business Logic Layer):** 核心是 `analysis_handler.py` 文件，负责编排整个分析流程。
*   **数据访问/模型层 (Data Access/Model Layer):** 封装在 `models/` 目录中，处理所有与AI模型相关的操作。

这种分层确保了每一层都可以独立修改和测试。例如，更新UI不会影响后端逻辑。

#### 2.2. 项目结构

```
DDoS_Traffic_Analysis_System/
|
|-- app.py                      # 核心Flask应用 (表现层)
|-- analysis_handler.py         # 业务逻辑层
|-- requirements.txt
|
|-- models/                     # 数据访问/模型层
|   |-- __init__.py
|   |-- model_definition.py       # 模型架构定义
|   |-- prediction.py             # 模型推理接口
|   |-- ddos_detection_model.pth  # 模型权重
|
|-- static/                     # 前端静态资源 (表现层)
|-- templates/                  # HTML模板 (表现层)
|
|-- uploads/                    # (自动创建) 用户上传文件
|-- reports/                    # (自动创建) 生成的报告
```

#### 2.3. 数据流

典型的用户工作流会触发以下数据流：

1.  **上传:** 用户在 `index.html` 页面选择一个CSV文件并提交表单。
2.  **请求处理:** `app.py` 接收 `POST` 请求，将文件保存到 `/uploads` 目录，并调用 `analysis_handler.py` 中的 `process_uploaded_file()` 函数。
3.  **数据处理:** `analysis_handler.py` 读取CSV到Pandas DataFrame，并验证必需的特征列。
4.  **预测:** `analysis_handler.py` 将特征DataFrame传递给 `models/prediction.py` 中的 `run_prediction()` 函数。
5.  **推理:** `models/prediction.py` 遍历数据，将每一行转换为PyTorch张量，并输入到预加载的模型中以获取预测概率。
6.  **后处理与报告生成:** `analysis_handler.py` 接收预测结果，用新列（`Risk_Score`, `Alert_Triggered`）增强DataFrame，计算摘要，并保存完整报告和告警报告到 `/reports` 目录。
7.  **响应生成:** `analysis_handler.py` 将一个包含所有必要数据（UI预览、摘要、报告文件名）的元组返回给 `app.py`。
8.  **渲染:** `app.py` 使用这些数据渲染 `results.html` 模板以供显示。
9.  **下载:** 如果用户点击下载按钮，`app.py` 中的 `download_report()` 路由会从 `/reports` 目录提供相应的文件。

---

### 3. 核心模块API文档

本节详细解释关键Python文件的功能和API。

#### 3.1. 业务逻辑层: `analysis_handler.py`

此模块是系统的“流程控制器”，负责编排整个分析工作流。

##### 函数: `process_uploaded_file(upload_filepath, report_dir, original_filename)`

* **目的:** 作为模块唯一的对外接口，执行从数据读取、模型调用到报告生成和UI数据准备的完整流程。

* **参数:**

  *   `upload_filepath` (str): 已保存在服务器上的用户上传CSV文件的绝对路径。
  *   `report_dir` (str): 用于存储生成的CSV报告的目录路径。
  *   `original_filename` (str): 用户上传的原始文件名，用于命名报告。

* **返回值:** 一个包含5个元素的元组 `(tuple)`:

  1.  `display_predictions` (list): 用于UI展示的完整数据预览列表。
  2.  `display_alerts` (list): 用于UI展示的告警数据列表。
  3.  `summary` (dict): 包含所有统计摘要信息的字典。
  4.  `full_report_filename` (str): 生成的完整报告的文件名。
  5.  `alert_report_filename` (str or None): 生成的告警报告的文件名，若无告警则为 `None`。

* **如何调用 (来自 `app.py`):**

  ```python
  from analysis_handler import process_uploaded_file
  
  # ... 在一个Flask路由中 ...
  try:
      (preds, alerts, summary, report_fn, alert_fn) = process_uploaded_file(...)
      return render_template('results.html', predictions=preds, summary=summary, ...)
  except Exception as e:
      return render_template('error.html', error=str(e))
  ```

#### **3.2. AI模型层: `models/**`

##### 文件: `models/model_definition.py`

*   **目的:** **仅用于定义**PyTorch模型的神经网络结构。
*   **类: `DDoSDetector(nn.Module)`**: 定义了一个堆叠式LSTM网络。其 `forward()` 方法指定了数据在网络层间的流动路径。

##### **文件: `models/prediction.py**`

* **目的:** 提供一个**干净、高效、隔离的推理接口**。它在应用启动时只加载一次模型，以实现高性能。

* **函数: `run_prediction(df_predict)`**

  * **目的:** 接收一个准备好的DataFrame，使用全局加载的模型进行预测，并返回结果。这是此模块**唯一对外暴露**的函数。

  * **参数:**

    *   `df_predict` (pandas.DataFrame): 一个**必须包含且仅包含**模型所需10个特征列的DataFrame，且顺序必须正确。

  * **返回值:** 一个包含2个元素的元组 `(tuple)`:

    1.  `predictions_list` (list): 包含预测类别（`'DDoS'` 或 `'BENIGN'`）的字符串列表。
    2.  `probabilities_list` (list): 包含格式化后的预测概率的字符串列表。

  * **如何调用 (来自 `analysis_handler.py`):**

    ```python
    from models.prediction import run_prediction
    
    pred_classes, pred_probs = run_prediction(df_features)
    df['Prediction_Class'] = pred_classes
    ```

#### 3.3. 主应用与认证: app.py

app.py 是Flask应用的核心，不仅处理Web请求路由，还集成了用户认证和会话管理功能。

- **核心职责:**
  - **用户认证:** 通过与**Google Firebase Firestore**的集成，处理用户注册、登录和登出逻辑。
  - **会话管理:** 利用Flask的 session 对象在用户登录后跟踪其状态，保护需要认证的端点。
  - **请求路由:** 定义所有Web端点（见第4节），并将请求分派到适当的处理逻辑（例如，文件上传到 analysis_handler）。
  - **服务静态文件与模板:** 渲染HTML页面并提供CSS/JS等静态资源。
- **Firebase集成:**
  - 应用启动时，使用 serviceAccountKey.json 初始化Firebase Admin SDK。
  - 所有用户数据（用户名、电话、密码）都存储在名为 users 的Firestore集合中。
  - 注册时会检查电话或用户名是否已存在，以确保唯一性。

---

### 4. Web路由 (API端点)

应用提供了以下API端点，分为用户认证和核心分析功能两部分。

#### 4.1. 认证端点

这些端点共同构成了完整的用户认证流程。

**GET /**

- **目的:** 显示主登录/注册页面 (login_register.html)。这是所有用户的入口点。
- **响应:** 渲染后的HTML页面。

**POST     /api/register**

- **目的:** 处理新用户注册请求。
- **请求体:** application/json，包含 phone, username, 和 password。
- **响应:**
  - registerSuccess (状态码 200): 用户创建成功。
  - registerFailed (状态码 200): 电话或用户名已存在。
  - Data not full (状态码 400): 请求数据不完整。

**POST     /api/login**

- **目的:** 处理用户登录请求。
- **请求体:** application/x-www-form-urlencoded，包含 IdAccount (可以是用户名或电话) 和 password。
- **响应:**
  - main (状态码 200): 登录成功。服务器会设置用户会话，客户端应重定向到 /upload。
  - login failure... (状态码 200): 凭据不正确。
  - data not full (状态码 400): 请求数据不完整。

**GET     /api/logout**

- **目的:** 清除当前用户的会话并登出。
- **响应:** 重定向到根URL / (登录页面)。

#### 4.2. 核心功能端点

这些端点是系统的主要分析功能。

**GET, POST     /upload**

- **目的:**
  - **GET:** 显示文件上传页面 (index.html)，这是进行DDoS分析的主界面。
  - **POST:** 处理上传的CSV文件以进行分析。这是触发整个分析流程的核心端点。
- **请求体 (POST):** multipart/form-data，必须包含一个名为 file 的文件部分。
- **响应:**
  - **成功:** 渲染包含分析结果、摘要和下载链接的 results.html 页面。
  - **失败:** 如果文件无效、处理出错或未选择文件，将重定向回上传页面并通过 flash 消息显示错误，或渲染 error.html 页面显示具体异常。

**GET     /download/<filename>**

- **目的:** 允许用户下载先前生成的报告文件。
- **URL参数:** filename (str) - 在 results.html 页面中提供的报告文件名。
- **响应:** 从 /reports 目录中找到对应的文件，并作为附件提供给浏览器下载。